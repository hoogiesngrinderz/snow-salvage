name: Ingest Partzilla

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"   # daily at 3am UTC

jobs:
  ingest:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # ---- HARD RESET package.json (guaranteed valid) ----
      - name: Force known-good package.json
        run: |
          cat > package.json <<'JSON'
          {
            "name": "snow-salvage",
            "version": "0.1.0",
            "private": true,
            "scripts": {
              "dev": "next dev",
              "build": "next build",
              "start": "next start",
              "lint": "eslint"
            },
            "dependencies": {
              "@supabase/supabase-js": "^2.97.0",
              "next": "16.1.6",
              "react": "19.2.3",
              "react-dom": "19.2.3",
              "fast-xml-parser": "^4.0.0",
              "cheerio": "^1.0.0",
              "p-queue": "^7.0.0"
            },
            "devDependencies": {
              "@tailwindcss/postcss": "^4",
              "@types/node": "^20",
              "@types/react": "^19",
              "@types/react-dom": "^19",
              "eslint": "^9",
              "eslint-config-next": "16.1.6",
              "tailwindcss": "^4",
              "typescript": "^5"
            }
          }
          JSON

          node -e "JSON.parse(require('fs').readFileSync('package.json','utf8')); console.log('package.json OK')"

      - name: Install dependencies
        run: npm install

      - name: Run Partzilla ingestor
        run: node scripts/ingest/partzilla.ts
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
